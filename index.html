<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Magic Tiles Infinity</title>
<style>
body {
    margin: 0; padding: 0;
    display: flex; justify-content: center; align-items: center;
    height: 100vh; font-family: 'B Nazanin', Tahoma, sans-serif;
    user-select: none;
    background: linear-gradient(120deg,#000428,#004e92);
    animation: bgmove 10s infinite alternate;
}
@keyframes bgmove {
    0% {background: linear-gradient(120deg,#000428,#004e92);}
    100% {background: linear-gradient(120deg,#004e92,#000428);}
}
#game-container {
    width: 320px; height: 500px;
    background-color: #111; border-radius: 10px;
    overflow: hidden; position: relative;
    box-shadow: 0 0 30px rgba(0,0,0,0.5);
}
#score-display {
    position: absolute; top: 10px; width: 100%;
    text-align: center; color: white; font-size: 1.8em; z-index: 10;
}
#game-area { width: 100%; height: 100%; position: relative; }
.tile {
    position: absolute; width: 25%; height: 125px;
    background-color: #1e88e5; cursor: pointer;
    border-radius: 0 0 10px 10px;
    box-shadow: 0 0 10px rgba(0,150,255,0.6);
    transition: background-color 0.1s, transform 0.1s;
}
.tile.hit {
    background-color: #4CAF50; transform: scale(1.1);
    box-shadow: 0 0 15px #4CAF50;
}
.tile.missed {
    background-color: #F44336; box-shadow: 0 0 20px #F44336;
}
#game-over-screen {
    position: absolute; top:0; left:0;
    width:100%; height:100%; background: rgba(0,0,0,0.85);
    display:none; flex-direction: column; justify-content: center; align-items: center;
    color:white; text-align:center;
}
#game-over-screen button {
    padding: 10px 20px; font-size: 1.2em;
    cursor: pointer; background-color: #4CAF50;
    color: white; border: none; border-radius: 5px;
}
#game-over-screen button:hover {background-color:#388E3C;}
</style>
</head>
<body>

<div id="game-container">
    <div id="score-display">امتیاز: 0</div>
    <div id="game-area"></div>
    <div id="game-over-screen">
        <h1>بازی تمام شد!</h1>
        <p>امتیاز نهایی: <span id="final-score">0</span></p>
        <button onclick="startGame()">شروع مجدد</button>
    </div>
</div>

<audio id="bg-music" preload="auto"></audio>

<script>
const MUSIC_LINKS = [
    "https://www.bensound.com/bensound-music/bensound-slowmotion.mp3",
    "https://www.bensound.com/bensound-music/bensound-tomorrow.mp3",
    "https://www.bensound.com/bensound-music/bensound-tenderness.mp3",
    "https://www.bensound.com/bensound-music/bensound-sweet.mp3",
    "https://www.bensound.com/bensound-music/bensound-dreams.mp3",
    "https://www.bensound.com/bensound-music/bensound-love.mp3",
    "https://www.bensound.com/bensound-music/bensound-onceagain.mp3",
    "https://www.bensound.com/bensound-music/bensound-creativeminds.mp3"
];

const gameArea = document.getElementById("game-area");
const scoreDisplay = document.getElementById("score-display");
const gameOverScreen = document.getElementById("game-over-screen");
const finalScore = document.getElementById("final-score");
const audio = document.getElementById("bg-music");

let score = 0, isGameOver = false, tileFallSpeed = 3;
let currentSong = "", tiles = [], columnFlags = [false,false,false,false];

let gameLoopInterval;

function startGame() {
    clearInterval(gameLoopInterval);
    gameArea.innerHTML = ""; score=0; tileFallSpeed=3; isGameOver=false;
    tiles=[]; columnFlags=[false,false,false,false];
    scoreDisplay.textContent="امتیاز: 0";
    gameOverScreen.style.display="none";

    currentSong = MUSIC_LINKS[Math.floor(Math.random()*MUSIC_LINKS.length)];
    audio.src = currentSong; audio.playbackRate=1; audio.play();

    createTileWave();
    gameLoopInterval = setInterval(gameLoop, 1000/60);

    audio.onended = () => {
        tileFallSpeed *= 1.5;
        audio.playbackRate += 0.15;
        audio.currentTime=0; audio.play();
    };
}

function createTileWave() {
    if(isGameOver) return;

    const tileCount = Math.random()<0.7?1:Math.floor(Math.random()*3)+1;
    const usedCols = [];

    for(let i=0;i<tileCount;i++){
        let col;
        do { col=Math.floor(Math.random()*4); } while (usedCols.includes(col) || columnFlags[col]);
        usedCols.push(col); columnFlags[col]=true;

        const tile=document.createElement("div");
        tile.classList.add("tile");
        tile.style.left=`${col*25}%`;
        tile.style.top="-125px";

        tile.onclick = () => {
            if(isGameOver) return;
            tile.classList.add("hit"); score++;
            scoreDisplay.textContent=`امتیاز: ${score}`;
            tile.onclick=null;
            columnFlags[col]=false;
            setTimeout(()=>tile.remove(),100);
        };

        tiles.push(tile); gameArea.appendChild(tile);
    }

    // ریتم پویا هماهنگ با سرعت آهنگ
    let nextDelay = (Math.random()*400+400)/audio.playbackRate; // 400~800ms
    setTimeout(createTileWave,nextDelay);
}

function gameLoop() {
    if(isGameOver) return;
    for(let i=tiles.length-1;i>=0;i--){
        const t=tiles[i]; const y=parseFloat(t.style.top||0)+tileFallSpeed;
        t.style.top=`${y}px`;
        if(y>gameArea.clientHeight){
            endGame(t);
        }
    }
}

function endGame(tile){
    if(isGameOver) return;
    isGameOver=true;
    clearInterval(gameLoopInterval);
    audio.pause();
    if(tile) tile.classList.add("missed");
    finalScore.textContent=score;
    gameOverScreen.style.display="flex";
}

startGame();
</script>
</body>
</html>
