<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🎵 Magic Tiles Pro+</title>
<style>
body {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    background-color: #111;
    font-family: "B Nazanin", Tahoma, sans-serif;
    user-select: none;
}
#game-container {
    width: 320px;
    height: 500px;
    background-color: #000;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 0 40px rgba(0, 255, 100, 0.3);
}
#score-display {
    position: absolute;
    top: 10px;
    width: 100%;
    text-align: center;
    color: #fff;
    font-size: 1.8em;
    z-index: 10;
}
#game-area {
    width: 100%;
    height: 100%;
    position: relative;
}
.tile {
    position: absolute;
    width: 25%;
    height: 125px;
    background-color: #4CAF50;
    left: 0;
    border-radius: 0 0 6px 6px;
    box-shadow: inset 0 -6px 0 #2e7d32;
    cursor: pointer;
    transition: background-color 0.05s;
}
.tile.hit {
    background-color: #FFD54F !important;
}
.tile.missed {
    background-color: #E53935 !important;
}
#game-over-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    backdrop-filter: blur(5px);
}
#game-over-screen button {
    background-color: #4CAF50;
    border: none;
    color: white;
    font-size: 1.2em;
    border-radius: 8px;
    padding: 10px 25px;
    cursor: pointer;
}
</style>
</head>
<body>

<div id="game-container">
    <div id="score-display">امتیاز: 0</div>
    <div id="game-area"></div>
    <div id="game-over-screen">
        <h1>🎮 بازی تمام شد</h1>
        <p>امتیاز نهایی: <span id="final-score">0</span></p>
        <button onclick="startGame()">شروع مجدد</button>
    </div>
</div>

<audio id="bg-music" preload="auto"></audio>

<script>
// 🎵 لیست موزیک‌ها
const MUSIC_LINKS = [
    "https://www.bensound.com/bensound-music/bensound-tomorrow.mp3",
    "https://www.bensound.com/bensound-music/bensound-creativeminds.mp3",
    "https://www.bensound.com/bensound-music/bensound-dreams.mp3"
];

const gameArea = document.getElementById("game-area");
const scoreDisplay = document.getElementById("score-display");
const gameOverScreen = document.getElementById("game-over-screen");
const finalScore = document.getElementById("final-score");
const audio = document.getElementById("bg-music");

let score = 0;
let isGameOver = false;
let gameLoopInterval;
let currentBPM = 100; // ضرب تقریبی پیش‌فرض
let tileFallSpeed = 3;
const tileHeight = 125;

// 🎵 انتخاب موزیک تصادفی
function chooseRandomMusic() {
    return MUSIC_LINKS[Math.floor(Math.random() * MUSIC_LINKS.length)];
}

// 🔊 راه‌اندازی پخش موسیقی و تشخیص ریتم (با Web Audio API)
async function setupMusicAndRhythm() {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const source = ctx.createMediaElementSource(audio);
    const analyser = ctx.createAnalyser();
    source.connect(analyser);
    analyser.connect(ctx.destination);
    analyser.fftSize = 256;
    const dataArray = new Uint8Array(analyser.frequencyBinCount);

    // آنالیز صدا برای تشخیص شدت ضرب‌ها
    setInterval(() => {
        analyser.getByteFrequencyData(dataArray);
        const avg = dataArray.reduce((a, b) => a + b) / dataArray.length;
        if (avg > 180) createTile(); // هر بار ضرب بالا می‌رود، کاشی بساز
    }, 100);
}

// 🎮 شروع بازی
function startGame() {
    clearInterval(gameLoopInterval);
    gameArea.innerHTML = "";
    score = 0;
    isGameOver = false;
    scoreDisplay.textContent = "امتیاز: 0";
    gameOverScreen.style.display = "none";

    // شروع موسیقی
    const musicSrc = chooseRandomMusic();
    audio.src = musicSrc;
    audio.play();

    setupMusicAndRhythm();

    gameLoopInterval = setInterval(gameLoop, 1000 / 60);
}

// 🎵 ایجاد کاشی در موقعیت تصادفی (فقط کاشی سبز)
function createTile() {
    const tile = document.createElement("div");
    tile.classList.add("tile");
    const column = Math.floor(Math.random() * 4);
    tile.style.left = `${column * 25}%`;
    tile.style.top = `-125px`;

    tile.onclick = () => {
        if (isGameOver) return;
        tile.classList.add("hit");
        score++;
        scoreDisplay.textContent = `امتیاز: ${score}`;
        tile.onclick = null;
        setTimeout(() => tile.remove(), 100);
    };

    gameArea.appendChild(tile);
}

// 🔄 حلقه‌ی اصلی بازی
function gameLoop() {
    if (isGameOver) return;

    const tiles = document.querySelectorAll(".tile");
    tiles.forEach(tile => {
        const currentY = parseFloat(tile.style.top || 0);
        const newY = currentY + tileFallSpeed;
        tile.style.top = `${newY}px`;

        // اگر کاشی از پایین گذشت و زده نشده بود
        if (newY > gameArea.clientHeight) {
            endGame(tile);
        }
    });
}

// ❌ پایان بازی
function endGame(tile) {
    if (isGameOver) return;
    isGameOver = true;
    clearInterval(gameLoopInterval);
    audio.pause();
    if (tile) tile.classList.add("missed");
    finalScore.textContent = score;
    gameOverScreen.style.display = "flex";
}

// ▶ شروع خودکار در لود اولیه
startGame();
</script>
</body>
</html>
