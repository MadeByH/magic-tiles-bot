<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸµ Magic Tiles Pro+</title>
<style>
body {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    background-color: #111;
    font-family: "B Nazanin", Tahoma, sans-serif;
    user-select: none;
}
#game-container {
    width: 320px;
    height: 500px;
    background-color: #000;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 0 40px rgba(0, 255, 100, 0.3);
}
#score-display {
    position: absolute;
    top: 10px;
    width: 100%;
    text-align: center;
    color: #fff;
    font-size: 1.8em;
    z-index: 10;
}
#game-area {
    width: 100%;
    height: 100%;
    position: relative;
}
.tile {
    position: absolute;
    width: 25%;
    height: 125px;
    background-color: #4CAF50;
    left: 0;
    border-radius: 0 0 6px 6px;
    box-shadow: inset 0 -6px 0 #2e7d32;
    cursor: pointer;
    transition: background-color 0.05s;
}
.tile.hit {
    background-color: #FFD54F !important;
}
.tile.missed {
    background-color: #E53935 !important;
}
#game-over-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    backdrop-filter: blur(5px);
}
#game-over-screen button {
    background-color: #4CAF50;
    border: none;
    color: white;
    font-size: 1.2em;
    border-radius: 8px;
    padding: 10px 25px;
    cursor: pointer;
}
</style>
</head>
<body>

<div id="game-container">
    <div id="score-display">Ø§Ù…ØªÛŒØ§Ø²: 0</div>
    <div id="game-area"></div>
    <div id="game-over-screen">
        <h1>ğŸ® Ø¨Ø§Ø²ÛŒ ØªÙ…Ø§Ù… Ø´Ø¯</h1>
        <p>Ø§Ù…ØªÛŒØ§Ø² Ù†Ù‡Ø§ÛŒÛŒ: <span id="final-score">0</span></p>
        <button onclick="startGame()">Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯</button>
    </div>
</div>

<audio id="bg-music" preload="auto"></audio>

<script>
// ğŸµ Ù„ÛŒØ³Øª Ù…ÙˆØ²ÛŒÚ©â€ŒÙ‡Ø§
const MUSIC_LINKS = [
    "https://www.bensound.com/bensound-music/bensound-tomorrow.mp3",
    "https://www.bensound.com/bensound-music/bensound-creativeminds.mp3",
    "https://www.bensound.com/bensound-music/bensound-dreams.mp3"
];

const gameArea = document.getElementById("game-area");
const scoreDisplay = document.getElementById("score-display");
const gameOverScreen = document.getElementById("game-over-screen");
const finalScore = document.getElementById("final-score");
const audio = document.getElementById("bg-music");

let score = 0;
let isGameOver = false;
let gameLoopInterval;
let currentBPM = 100; // Ø¶Ø±Ø¨ ØªÙ‚Ø±ÛŒØ¨ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
let tileFallSpeed = 3;
const tileHeight = 125;

// ğŸµ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÙˆØ²ÛŒÚ© ØªØµØ§Ø¯ÙÛŒ
function chooseRandomMusic() {
    return MUSIC_LINKS[Math.floor(Math.random() * MUSIC_LINKS.length)];
}

// ğŸ”Š Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù¾Ø®Ø´ Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ùˆ ØªØ´Ø®ÛŒØµ Ø±ÛŒØªÙ… (Ø¨Ø§ Web Audio API)
async function setupMusicAndRhythm() {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const source = ctx.createMediaElementSource(audio);
    const analyser = ctx.createAnalyser();
    source.connect(analyser);
    analyser.connect(ctx.destination);
    analyser.fftSize = 256;
    const dataArray = new Uint8Array(analyser.frequencyBinCount);

    // Ø¢Ù†Ø§Ù„ÛŒØ² ØµØ¯Ø§ Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ø´Ø¯Øª Ø¶Ø±Ø¨â€ŒÙ‡Ø§
    setInterval(() => {
        analyser.getByteFrequencyData(dataArray);
        const avg = dataArray.reduce((a, b) => a + b) / dataArray.length;
        if (avg > 180) createTile(); // Ù‡Ø± Ø¨Ø§Ø± Ø¶Ø±Ø¨ Ø¨Ø§Ù„Ø§ Ù…ÛŒâ€ŒØ±ÙˆØ¯ØŒ Ú©Ø§Ø´ÛŒ Ø¨Ø³Ø§Ø²
    }, 100);
}

// ğŸ® Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ
function startGame() {
    clearInterval(gameLoopInterval);
    gameArea.innerHTML = "";
    score = 0;
    isGameOver = false;
    scoreDisplay.textContent = "Ø§Ù…ØªÛŒØ§Ø²: 0";
    gameOverScreen.style.display = "none";

    // Ø´Ø±ÙˆØ¹ Ù…ÙˆØ³ÛŒÙ‚ÛŒ
    const musicSrc = chooseRandomMusic();
    audio.src = musicSrc;
    audio.play();

    setupMusicAndRhythm();

    gameLoopInterval = setInterval(gameLoop, 1000 / 60);
}

// ğŸµ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø´ÛŒ Ø¯Ø± Ù…ÙˆÙ‚Ø¹ÛŒØª ØªØµØ§Ø¯ÙÛŒ (ÙÙ‚Ø· Ú©Ø§Ø´ÛŒ Ø³Ø¨Ø²)
function createTile() {
    const tile = document.createElement("div");
    tile.classList.add("tile");
    const column = Math.floor(Math.random() * 4);
    tile.style.left = `${column * 25}%`;
    tile.style.top = `-125px`;

    tile.onclick = () => {
        if (isGameOver) return;
        tile.classList.add("hit");
        score++;
        scoreDisplay.textContent = `Ø§Ù…ØªÛŒØ§Ø²: ${score}`;
        tile.onclick = null;
        setTimeout(() => tile.remove(), 100);
    };

    gameArea.appendChild(tile);
}

// ğŸ”„ Ø­Ù„Ù‚Ù‡â€ŒÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²ÛŒ
function gameLoop() {
    if (isGameOver) return;

    const tiles = document.querySelectorAll(".tile");
    tiles.forEach(tile => {
        const currentY = parseFloat(tile.style.top || 0);
        const newY = currentY + tileFallSpeed;
        tile.style.top = `${newY}px`;

        // Ø§Ú¯Ø± Ú©Ø§Ø´ÛŒ Ø§Ø² Ù¾Ø§ÛŒÛŒÙ† Ú¯Ø°Ø´Øª Ùˆ Ø²Ø¯Ù‡ Ù†Ø´Ø¯Ù‡ Ø¨ÙˆØ¯
        if (newY > gameArea.clientHeight) {
            endGame(tile);
        }
    });
}

// âŒ Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ
function endGame(tile) {
    if (isGameOver) return;
    isGameOver = true;
    clearInterval(gameLoopInterval);
    audio.pause();
    if (tile) tile.classList.add("missed");
    finalScore.textContent = score;
    gameOverScreen.style.display = "flex";
}

// â–¶ Ø´Ø±ÙˆØ¹ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± Ù„ÙˆØ¯ Ø§ÙˆÙ„ÛŒÙ‡
startGame();
</script>
</body>
</html>
